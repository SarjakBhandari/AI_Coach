<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>üèÄ Basketball AI Coach</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; padding: 20px; }
    h1, h2, h3 { color: #333; }
    input, button, video, pre, label { margin-bottom: 10px; }
    pre { background: #f0f0f0; padding: 10px; border-radius: 5px; white-space: pre-wrap; }
    .frame-report { margin-top: 30px; }
    .frame { background: white; padding: 15px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 0 5px rgba(0,0,0,0.1); }
    .feedback { margin-top: 10px; font-size: 0.95em; }
    .success { color: green; font-weight: bold; }
    .skipped { color: red; font-weight: bold; }
    img { margin-top: 10px; border-radius: 6px; box-shadow: 0 0 4px rgba(0,0,0,0.2); }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #eee; }
  </style>
</head>
<body>
  <h1>üèÄ Basketball Shot Analyzer</h1>

  <!-- üìù Registration -->
  <h2>üìù Register</h2>
  <input type="text" id="regUsername" placeholder="Username">
  <input type="email" id="regEmail" placeholder="Email">
  <input type="password" id="regPassword" placeholder="Password">
  <button onclick="register()">Register</button>
  <pre id="registerStatus">Not registered</pre>

  <!-- üîê Login -->
  <h2>üîê Login</h2>
  <input type="email" id="loginEmail" placeholder="Email">
  <input type="password" id="loginPassword" placeholder="Password">
  <button onclick="login()">Login</button>
  <button onclick="logout()">Logout</button>
  <pre id="loginStatus">Not logged in</pre>

  <!-- üé• Live Webcam Mode -->
  <h2>Live Webcam</h2>
  <video id="liveVideo" width="480" height="360" autoplay muted></video><br>
  <button id="startBtn">Start Recording</button>
  <button id="stopBtn" disabled>Stop & Analyze</button>
  <label><input type="checkbox" id="saveFlagLive"> Save feedback to my account</label>
  <h3>Live Feedback:</h3>
  <pre id="liveFeedback">Waiting for analysis...</pre>

  <!-- üìÇ Video Upload Mode -->
  <h2>Upload Video</h2>
  <input type="file" id="uploadInput" accept="video/*"><br>
  <label><input type="checkbox" id="saveFlagUpload"> Save feedback to my account</label>
  <button id="analyzeUploadBtn">Analyze Uploaded Video</button>
  <h3>Upload Feedback:</h3>
  <pre id="uploadFeedback">No feedback yet.</pre>

  <!-- üì∏ Frame Analysis -->
  <div class="frame-report">
    <h2>üì∏ Frame Analysis Report</h2>
    <div id="frameContainer">No frames analyzed yet.</div>
  </div>

  <!-- üìú Saved Feedback History -->
  <h2>üìú Saved Feedback History</h2>
  <button onclick="loadHistory()">Load History</button>
  <div id="historyContainer">No history loaded.</div>

  <!-- üì§ Export -->
  <h2>üì§ Export Feedback</h2>
  <a href="/export-history" target="_blank"><button>Download CSV</button></a>

  <script>
    let mediaRecorder;
    let recordedChunks = [];

    async function register() {
      const username = document.getElementById("regUsername").value;
      const email = document.getElementById("regEmail").value;
      const password = document.getElementById("regPassword").value;

      const res = await fetch("/register", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, email, password })
      });

      const data = await res.json();
      document.getElementById("registerStatus").innerText = data.message || data.error;
    }

    async function login() {
      const email = document.getElementById("loginEmail").value;
      const password = document.getElementById("loginPassword").value;

      const res = await fetch("/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, password })
      });

      const data = await res.json();
      document.getElementById("loginStatus").innerText = data.message || data.error;
    }

    async function logout() {
      await fetch("/logout", { method: "POST" });
      document.getElementById("loginStatus").innerText = "Logged out";
    }

    navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
      document.getElementById("liveVideo").srcObject = stream;
      mediaRecorder = new MediaRecorder(stream);

      mediaRecorder.ondataavailable = e => {
        if (e.data.size > 0) recordedChunks.push(e.data);
      };

      mediaRecorder.onstop = async () => {
        const blob = new Blob(recordedChunks, { type: "video/webm" });
        const formData = new FormData();
        formData.append("video", blob, "live_recording.webm");
        formData.append("save", document.getElementById("saveFlagLive").checked ? "true" : "false");

        document.getElementById("liveFeedback").innerText = "Analyzing video...";

        const res = await fetch("/upload-video", {
          method: "POST",
          body: formData
        });

        const data = await res.json();
        updateFrameReport(data.feedback, "liveFeedback");
        recordedChunks = [];
      };
    });

    document.getElementById("startBtn").onclick = () => {
      recordedChunks = [];
      mediaRecorder.start();
      document.getElementById("stopBtn").disabled = false;
    };

    document.getElementById("stopBtn").onclick = () => {
      mediaRecorder.stop();
      document.getElementById("stopBtn").disabled = true;
    };

    document.getElementById("analyzeUploadBtn").onclick = async () => {
      const input = document.getElementById("uploadInput");
      if (!input.files.length) {
        alert("Select a video file first.");
        return;
      }

      const formData = new FormData();
      formData.append("video", input.files[0]);
      formData.append("save", document.getElementById("saveFlagUpload").checked ? "true" : "false");

      document.getElementById("uploadFeedback").innerText = "Processing uploaded video...";

      const res = await fetch("/upload-video", {
        method: "POST",
        body: formData
      });

      const data = await res.json();
      updateFrameReport(data.feedback, "uploadFeedback");
    };

function updateFrameReport(feedbackArray, feedbackTargetId) {
  const container = document.getElementById("frameContainer");
  container.innerHTML = "";

  if (!feedbackArray || !feedbackArray.length) {
    container.innerHTML = "<p>No frames received.</p>";
    document.getElementById(feedbackTargetId).innerText = "No feedback received.";
    return;
  }

  document.getElementById(feedbackTargetId).innerText = "Feedback received.";

  feedbackArray.forEach(frame => {
    const div = document.createElement("div");
    div.className = "frame";

    const img = document.createElement("img");
    img.src = frame.image;
    img.alt = `Frame ${frame.frame_id}`;
    img.style.maxWidth = "400px";
    div.appendChild(img);

    const feedback = document.createElement("div");
    feedback.className = "feedback";
    feedback.innerHTML = frame.summary.includes("Skipped")
      ? `<span class="skipped">${frame.summary}</span>`
      : `<span class="success">${frame.summary}</span>`;
    div.appendChild(feedback);

    container.appendChild(div);
  });
}


    async function loadHistory() {
      const res = await fetch("/feedback-history");
      const data = await res.json();

      const container = document.getElementById("historyContainer");
      if (!data.length) {
        container.innerHTML = "<p>No feedback history found.</p>";
        return;
      }

           let html = "<table><tr><th>Suggestion</th><th>Timestamp</th></tr>";
      data.forEach(item => {
        html += `<tr>
          <td>${item.summary}</td>
          <td>${item.timestamp}</td>
        </tr>`;
      });
      html += "</table>";
      container.innerHTML = html;
    }
  </script>
</body>
</html>
